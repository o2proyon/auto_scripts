name: ğŸ”„ KataBump Auto Renew

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶è§¦å‘
  schedule:
    # UTC 00:12 (åŒ—äº¬æ—¶é—´ 08:12)
    - cron: "12 0 * * *"

# æƒé™é…ç½®ï¼šå…è®¸æäº¤å’Œæ¨é€æ›´æ”¹
permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PROJECT_DIR: katabump
      SCRIPT_NAME: kataBump_renew_batch.py
      SCRIPT_DESC: KataBump ç»­æœŸè„šæœ¬
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºå…¬å¼€ä»“åº“
      - name: ğŸ“¥ æ£€å‡ºå…¬å¼€ä»“åº“
        uses: actions/checkout@v4
      
      # æ­¥éª¤ 1.5: åˆ›å»ºè¾“å‡ºç›®å½•
      - name: ğŸ“ åˆ›å»ºè¾“å‡ºç›®å½•
        run: mkdir -p ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}
        working-directory: .
      
      # æ­¥éª¤ 2: æ£€å‡ºç§æœ‰ä»“åº“
      - name: ğŸ” æ£€å‡ºç§æœ‰ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: o2proyon/auto_kataBump_private
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: main
          path: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}
          fetch-depth: 1

      # æ­¥éª¤ 3: è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: "**/requirements.txt"

      # æ­¥éª¤ 4: å®‰è£…ç³»ç»Ÿä¾èµ–
      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb fonts-noto-cjk fonts-noto-cjk-extra

      # æ­¥éª¤ 5: å®‰è£… Python ä¾èµ–
      - name: ğŸ“š å®‰è£… Python ä¾èµ–
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ æœªæ‰¾åˆ° requirements.txtï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
          fi
        working-directory: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}

      # æ­¥éª¤ 5.5: å®‰è£… Playwright æµè§ˆå™¨
      - name: ğŸŒ å®‰è£… Playwright æµè§ˆå™¨
        run: |
          python -m playwright install chromium
        working-directory: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}

      # æ­¥éª¤ 6: æ·»åŠ éšæœºå»¶è¿Ÿ
      - name: â³ æ·»åŠ éšæœºå»¶è¿Ÿ
        run: |
          delay=$((RANDOM % 120))
          echo "éšæœºå»¶è¿Ÿ: ${delay}ç§’"
          sleep $delay

      # æ­¥éª¤ 7: æ‰§è¡Œè„šæœ¬
      - name: ğŸš€ æ‰§è¡Œ ${{ env.SCRIPT_DESC }}
        env:
          KATABUMP_BATCH: ${{ secrets.KATABUMP_ACCOUNTS_BATCH }}
        run: xvfb-run -a python ${{ env.SCRIPT_NAME }}
        working-directory: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}

      # æ­¥éª¤ 8: ä¸Šä¼ æˆªå›¾åˆ° artifactsï¼Œ7å¤©å†…å¯ä¸‹è½½å‹ç¼©åŒ…
      - name: ğŸ“¸ ä¸Šä¼ æˆªå›¾åˆ° artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: katabump-screenshots
          path: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}/screenshots
          retention-days: 7
          if-no-files-found: warn

      # æ­¥éª¤ 9: æ¸…ç†åŸå§‹æˆªå›¾æ–‡ä»¶
      - name: ğŸ§¹ æ¸…ç†åŸå§‹æˆªå›¾æ–‡ä»¶
        if: always()
        run: |
          OUTPUT_DIR="${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}"
          if [ -d "$OUTPUT_DIR/screenshots" ]; then
            echo "ğŸ§¹ æ¸…ç†æˆªå›¾æ–‡ä»¶..."
            rm -f "$OUTPUT_DIR/screenshots"/*.png
            echo "âœ… æˆªå›¾æ–‡ä»¶å·²æ¸…ç†"
          else
            echo "âš ï¸ æˆªå›¾ç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€æ¸…ç†"
          fi

      # æ­¥éª¤ 10: æäº¤æ—¶é—´æ–‡ä»¶åˆ°å…¬å¼€åº“
      - name: â±ï¸ æäº¤æ—¶é—´æ–‡ä»¶
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          mkdir -p katabump && echo "$(date +'%Y-%m-%d %H:%M:%S')" > katabump/time.txt
          git add katabump/time.txt 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
            git commit -m "â±ï¸ æ›´æ–° katabump æ—¶é—´æ–‡ä»¶: $TIMESTAMP"
            git fetch origin main
            git push -f origin HEAD:main
            echo "âœ… æ›´æ”¹å·²æ¨é€"
          fi
